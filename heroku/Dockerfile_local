# Fase di build del backend
FROM eclipse-temurin:17-jdk-alpine AS build

# Crea una directory di lavoro nel container
WORKDIR /app

# Installazione di Maven
RUN apk add --no-cache maven

# Copia il file pom.xml e la cartella src
COPY backend/pom.xml .
COPY backend/src ./src

# Compila il progetto
RUN mvn clean package

# Fase finale
FROM eclipse-temurin:17-jdk-alpine

# Crea una directory per l'applicazione
WORKDIR /app

# Copia il JAR dell'applicazione
COPY --from=build /app/target/photo-event-backend-0.0.1-SNAPSHOT.jar /app/app.jar

# Installazione di Nginx
RUN apk add --no-cache nginx

# Copia i file statici del frontend in Nginx
COPY frontend/ /usr/share/nginx/html/

# Copia il file di configurazione Nginx
COPY backend/nginx/nginx.conf /etc/nginx/nginx.conf

# Espone le porte
EXPOSE 80 8080

# Comando di avvio per eseguire Nginx e il backend
CMD ["sh", "-c", "java -jar /app/app.jar & nginx -g 'daemon off;'"]
